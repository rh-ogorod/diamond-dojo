# Hey Emacs, this is -*- coding: utf-8; mode: bazel -*-

load("@aspect_bazel_lib//lib:run_binary.bzl", "run_binary")
load("@rules_cc//cc:defs.bzl", "cc_library")

filegroup(
  name = "all_srcs",
  srcs = glob([".rh-subproject/*", "package/**"]),
)

run_binary(
  name = "build",
  mnemonic = "BoostBuild",
  srcs = [":all_srcs"],
  out_dirs = ["package", "dist", "build"],
  tool = ".rh-subproject/bazel-build.sh",
  env = {"RULEDIR": "$(RULEDIR)"},
  execution_requirements = { "exclusive": "1" },
  visibility = ["//visibility:public"],
)

run_binary(
  name = "build_copy_lib",
  mnemonic = "BoostBuildCopyLibs",
  srcs = [":build"],
  outs = ["lib_copy/libboost_system-gcc11-mt-x64-1_80.a"],
  # outs = glob(["lib_copy/*.a"]),
  # out_dirs = ["lib_copy"],
  tool = ".rh-subproject/bazel-build-copy-lib.sh",
  env = {"RULEDIR": "$(RULEDIR)"},
  visibility = ["//visibility:public"],
)

cc_library(
  name = "boost",
  # hdrs = glob(["dist/include/boost-1_80/**"]),
  # strip_include_prefix = "dist/include/boost-1_80/",
  hdrs = glob(["package/boost/**"]),
  strip_include_prefix = "package/",
  srcs = [
    ":build_copy_lib",
  ],
  data = [":build"],
  visibility = ["//visibility:public"],
)
