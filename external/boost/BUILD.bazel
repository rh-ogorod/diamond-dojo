# Hey Emacs, this is -*- coding: utf-8; mode: bazel -*-

load("@aspect_bazel_lib//lib:run_binary.bzl", "run_binary")
load("@rules_cc//cc:defs.bzl", "cc_library")

filegroup(
  name = "all_srcs",
  srcs = glob([".rh-subproject/*", "package/**"]),
)

run_binary(
  name = "build",
  mnemonic = "BuildBoost",
  srcs = [":all_srcs"],
  outs = [
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.a",
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.so.1.80.0",
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.so",
  ],
  out_dirs = ["package", "dist/include", "build"],
  # out_dirs = ["package", "dist/include", "dist/lib", "build"],
  tool = ".rh-subproject/bazel-build.sh",
  env = {"RULEDIR": "$(RULEDIR)"},
  execution_requirements = { "exclusive": "1" },
  visibility = ["//visibility:public"],
)

cc_library(
  name = "boost",
  # hdrs = glob(["dist/include/boost-1_80/**"]),
  # strip_include_prefix = "dist/include/boost-1_80/",
  hdrs = glob(["package/boost/**"]),
  strip_include_prefix = "package/",
  srcs = [
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.a",
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.so.1.80.0",
    "dist/lib/libboost_system-gcc11-mt-x64-1_80.so",
  ],
  # srcs =
  #   glob(["dist/lib/*.a"]),
  #   # glob(["dist/lib/*.so"]) +
  #   # glob(["dist/lib/*.so.*"]),
  data = [":build"],
  visibility = ["//visibility:public"],
)
